@model El_Tringulito.Models.Mesas

@{
    ViewData["Title"] = "Ver Orden";
    bool puedeCancelar = ViewBag.EstadoGeneral == "Pendiente";
    bool tieneOrden = ViewBag.EstadoGeneral != "Sin Orden";
    bool esParaLlevar = ViewBag.EsParaLlevar ?? false;
    string nombreEntidad = esParaLlevar ? "Para Llevar" : Model.nombre;
}

<h1 class="text-center my-4">@nombreEntidad - @(tieneOrden ? $"Orden {ViewBag.EstadoGeneral}" : "Sin Orden")</h1>

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
}
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">@TempData["SuccessMessage"]</div>
}

<form asp-action="ActualizarOrden" method="post" onsubmit="agregarCamposOcultos()">
    @if (!esParaLlevar)
    {
        <input type="hidden" asp-for="id_mesa" />
    }

    <div class="mb-3">
        <label class="form-label">Nombre del Cliente</label>
        <input type="text" class="form-control" name="nombre_cliente" value="@ViewBag.NombreCliente" required @(ViewBag.EstadoGeneral == "En Proceso" ? "readonly" : "") />
    </div>

    <div class="mb-3">
        <label class="form-label">Agregar Producto</label>
        <div class="d-flex flex-wrap gap-2">
            <button type="button" class="btn btn-primary" onclick="cargarPlatos()">Platos</button>
            <button type="button" class="btn btn-success" onclick="cargarPromociones()">Promociones</button>
            <button type="button" class="btn btn-warning" onclick="cargarCombos()">Combos</button>
            <a asp-action="Index" class="btn btn-secondary ms-auto">Volver</a>
        </div>
    </div>

    <div id="productosSeleccionados" class="mb-3">
        <ul class="list-group" id="listaSeleccionados">
            @if (tieneOrden)
            {
                foreach (var item in ViewBag.OrdenesActivas)
                {
                    <li class="list-group-item bg-dark text-white mb-1">
                        <strong>@item.NombreProducto</strong> - $@item.Orden.total?.ToString("F2")
                        <span class="badge bg-secondary">@item.TipoProducto</span>
                        <span class="badge bg-info">@item.Orden.estado</span>
                        @if (item.Orden.para_llevar)
                        {
                            <span class="badge bg-info text-dark">Para llevar</span>
                        }
                        @if (!string.IsNullOrWhiteSpace(item.Orden.comentario))
                        {
                            <div class="mt-2"><small><strong>Comentario:</strong> @item.Orden.comentario</small></div>
                        }
                    </li>
                }
            }
        </ul>
    </div>

    <div class="mb-3">
        <label>Total</label>
        <input type="text" id="total" name="total" class="form-control" value="@(ViewBag.TotalOrdenes?.ToString("F2") ?? "0.00")" readonly />
    </div>

    <button type="submit" class="btn btn-success w-100">@(tieneOrden ? "Actualizar Orden" : "Crear Orden")</button>
</form>

<!-- Modal de Productos -->
<div class="modal fade" id="productosModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title">Seleccionar Producto</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent"></div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let productosSeleccionados = [];
        let total = parseFloat("@(ViewBag.TotalOrdenes ?? 0)");

        function cargarPlatos() {
            $.get("/MesasMesero/GetPlatos", data => mostrarModal(data, "platos"));
        }
        function cargarPromociones() {
            $.get("/MesasMesero/GetPromociones", data => mostrarModal(data, "promociones"));
        }
        function cargarCombos() {
            $.get("/MesasMesero/GetCombos", data => mostrarModal(data, "combos"));
        }

        function mostrarModal(data, tipo) {
            let html = '<div class="row">';
            data.forEach(p => {
                let id = p.id_plato || p.id_promocion || p.id_combo;
                html += `
                    <div class="col-md-4 mb-3">
                        <div class="card text-dark">
                            <div class="card-body">
                                <h5>${p.nombre}</h5>
                                <p class="text-muted">$${p.precio.toFixed(2)}</p>
                                <textarea class="form-control form-control-sm mb-2" id="comentario_${id}" placeholder="Comentario opcional"></textarea>
                                <button class="btn btn-outline-primary w-100" onclick="agregarProducto(${id}, '${tipo}', '${p.nombre}', ${p.precio})">Agregar</button>
                            </div>
                        </div>
                    </div>`;
            });
            html += '</div>';
            $("#modalContent").html(html);
            $('#productosModal').modal('show');
        }

        function agregarProducto(id, tipo, nombre, precio) {
            const comentario = document.getElementById(`comentario_${id}`)?.value || '';
            productosSeleccionados.push({
                id: id,
                tipo: tipo,
                comentario: comentario,
                precio: precio,
                paraLlevar: false
            });
            total += precio;
            $("#total").val(total.toFixed(2));

            $("#listaSeleccionados").append(`
                <li class="list-group-item bg-success text-white mb-1">
                    <strong>${nombre}</strong> - $${precio.toFixed(2)}
                    <span class="badge bg-primary">${tipo}</span>
                    ${comentario ? `<div class="mt-1"><small><strong>Comentario:</strong> ${comentario}</small></div>` : ''}
                </li>
            `);
            $('#productosModal').modal('hide');
        }

        function agregarCamposOcultos() {
            productosSeleccionados.forEach((p, i) => {
                $("#productosSeleccionados").append(`
                    <input type="hidden" name="productos[${i}].id" value="${p.id}" />
                    <input type="hidden" name="productos[${i}].tipo" value="${p.tipo}" />
                    <input type="hidden" name="productos[${i}].comentario" value="${p.comentario}" />
                    <input type="hidden" name="productos[${i}].precio" value="${p.precio}" />
                    <input type="hidden" name="productos[${i}].paraLlevar" value="${p.paraLlevar}" />
                `);
            });
        }
    </script>
}
